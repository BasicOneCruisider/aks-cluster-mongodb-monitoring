// ==========================================
// REQU√äTES KQL POUR CLUSTER K8WORKSHOPAKS-RESTORED
// ==========================================

// üéØ REQU√äTE PRINCIPALE - CONFIRMER EXISTENCE ET FONCTIONNEMENT DU CLUSTER
// ========================================================================

// REQU√äTE SIMPLE - V√©rifier que le cluster existe
KubeNodeInventory
| where ClusterName == "K8workshopaks-restored"
| where TimeGenerated > ago(24h)
| summarize 
    NodesTotal = dcount(Computer),
    NodesReady = dcountif(Computer, Status == "Ready"),
    DerniereActivite = max(TimeGenerated),
    Nodes = make_set(Computer)
| extend 
    ClusterStatus = iff(NodesTotal > 0, "CLUSTER EXISTE", "CLUSTER INTROUVABLE"),
    NodesStatus = iff(NodesReady == NodesTotal, "TOUS NODES READY", strcat(NodesReady, "/", NodesTotal, " READY")),
    ActiviteStatus = iff(DerniereActivite > ago(1h), "ACTIF", "DONNEES ANCIENNES")

// DIAGNOSTIC - V√©rifier si les donn√©es arrivent
// =============================================

// DIAG 1. V√©rifier toutes les donn√©es du cluster (toutes tables)
search "K8workshopaks-restored"
| summarize count() by $table
| order by count_ desc

// DIAG 2. V√©rifier les donn√©es r√©centes (derni√®res 24h)
union withsource=TableName *
| where TimeGenerated > ago(24h)
| where * contains "K8workshopaks-restored" or * contains "mongodb" or * contains "ratingapp"
| summarize count() by TableName
| order by count_ desc

// DIAG 3. V√©rifier la connectivit√© des agents
Heartbeat
| where TimeGenerated > ago(1h)
| summarize max(TimeGenerated) by Computer
| order by max_TimeGenerated desc

// DIAG 4. V√©rifier les √©v√©nements des agents de monitoring
KubeMonAgentEvents
| where TimeGenerated > ago(1h)
| order by TimeGenerated desc
| take 20

// ==========================================
// REQU√äTES PRINCIPALES (si donn√©es disponibles)
// ==========================================

// 1. √âtat g√©n√©ral des pods
KubePodInventory
| where ClusterName == "K8workshopaks-restored"
| summarize count() by PodStatus, Namespace
| order by count_ desc

// 2. Pods MongoDB sp√©cifiquement
KubePodInventory
| where ClusterName == "K8workshopaks-restored"
| where Name contains "mongodb"
| project TimeGenerated, Name, Namespace, PodStatus, ContainerStatusReason, RestartCount
| order by TimeGenerated desc

// 3. Logs MongoDB en temps r√©el
ContainerLogV2
| where ContainerName contains "mongodb"
| order by TimeGenerated desc
| take 50

// 4. M√©triques CPU des nodes
InsightsMetrics
| where Name == "cpuUsageNanoCores"
| where Tags contains "K8workshopaks-restored"
| summarize avg(Val) by bin(TimeGenerated, 5m), Computer
| render timechart

// 5. M√©triques m√©moire des nodes
InsightsMetrics
| where Name == "memoryWorkingSetBytes"
| where Tags contains "K8workshopaks-restored"
| summarize avg(Val) by bin(TimeGenerated, 5m), Computer
| render timechart

// 6. √âv√©nements Kubernetes importants
KubeEvents
| where ClusterName == "K8workshopaks-restored"
| where Type == "Warning" or Reason == "FailedScheduling"
| project TimeGenerated, Reason, Message, ObjectKind, ObjectName
| order by TimeGenerated desc

// 7. √âtat de sant√© du cluster
KubeHealth
| where ClusterName == "K8workshopaks-restored"
| summarize count() by ServiceName, HealthState
| order by count_ desc

// 8. Utilisation des ressources par namespace
KubePodInventory
| where ClusterName == "K8workshopaks-restored"
| summarize PodCount = count() by Namespace
| order by PodCount desc

// 9. Inventaire des nodes et leur statut
KubeNodeInventory
| where ClusterName == "K8workshopaks-restored"
| project TimeGenerated, Computer, Status, KubeletVersion, DockerVersion
| order by TimeGenerated desc

// 10. Logs d'erreur dans tous les containers
ContainerLogV2
| where LogLevel == "Error" or LogEntry contains "error"
| where TimeGenerated > ago(1h)
| order by TimeGenerated desc
| take 100

// ==========================================
// REQU√äTES ALTERNATIVES (monitoring en temps r√©el via kubectl)
// ==========================================

// Alternative 1: Utiliser kubectl directement
// kubectl get pods --all-namespaces -o wide
// kubectl top nodes
// kubectl top pods --all-namespaces

// Alternative 2: Logs en temps r√©el
// kubectl logs -f <pod-name> --namespace ratingapp

// Alternative 3: √âv√©nements Kubernetes
// kubectl get events --all-namespaces --sort-by='.lastTimestamp'

// ==========================================
// REQU√äTES DE FALLBACK (donn√©es plus anciennes)
// ==========================================

// FB 1. Chercher dans toutes les tables sans filtre cluster
KubePodInventory
| where TimeGenerated > ago(7d)
| where Namespace == "ratingapp"
| order by TimeGenerated desc
| take 10

// FB 2. Logs MongoDB sans filtre cluster
ContainerLogV2
| where TimeGenerated > ago(7d)
| where ContainerName contains "mongodb"
| order by TimeGenerated desc
| take 10

// FB 3. Activit√© Azure g√©n√©rale
AzureActivity
| where TimeGenerated > ago(1h)
| where ResourceGroup == "aks-restored-rg"
| order by TimeGenerated desc
| take 20