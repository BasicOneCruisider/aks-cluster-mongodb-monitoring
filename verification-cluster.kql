// REQU√äTE SIMPLE - V√âRIFICATION CLUSTER K8WORKSHOPAKS-RESTORED
// ==========================================================

// ‚úÖ REQU√äTE PRINCIPALE - Confirmer que le cluster existe et fonctionne
KubeNodeInventory
| where ClusterName == "K8workshopaks-restored"
| where TimeGenerated > ago(24h)
| summarize 
    NodesTotal = dcount(Computer),
    NodesReady = dcountif(Computer, Status == "Ready"),
    DerniereActivite = max(TimeGenerated),
    Nodes = make_set(Computer)
| extend 
    ClusterStatus = iff(NodesTotal > 0, "‚úÖ CLUSTER EXISTE", "‚ùå CLUSTER INTROUVABLE"),
    NodesStatus = iff(NodesReady == NodesTotal, "‚úÖ TOUS NODES READY", strcat("‚ö†Ô∏è ", NodesReady, "/", NodesTotal, " READY")),
    ActiviteStatus = iff(DerniereActivite > ago(1h), "‚úÖ ACTIF", "‚ö†Ô∏è DONNEES ANCIENNES")
| project ClusterStatus, NodesStatus, ActiviteStatus, NodesTotal, NodesReady, DerniereActivite, Nodes

// üìä ALTERNATIVE - Si pas de donn√©es dans KubeNodeInventory, chercher dans toutes les tables
search "K8workshopaks-restored"
| where TimeGenerated > ago(24h)
| summarize 
    TablesAvecDonnees = dcount($table),
    DerniereActivite = max(TimeGenerated),
    Tables = make_set($table),
    TotalRecords = count()
| extend Status = iff(TotalRecords > 0, "‚úÖ CLUSTER DETECTE", "‚ùå AUCUNE DONNEE")
| project Status, TablesAvecDonnees, TotalRecords, DerniereActivite, Tables

// üóÑÔ∏è V√âRIFICATION MONGODB - Confirmer que MongoDB fonctionne
KubePodInventory
| where ClusterName == "K8workshopaks-restored"
| where Name contains "mongodb"
| where TimeGenerated > ago(24h)
| summarize 
    PodsTotal = count(),
    PodsRunning = countif(PodStatus == "Running"),
    DerniereActivite = max(TimeGenerated),
    Namespaces = make_set(Namespace)
| extend 
    MongoStatus = iff(PodsRunning > 0, "‚úÖ MONGODB RUNNING", iff(PodsTotal > 0, "‚ö†Ô∏è MONGODB PRESENT MAIS PAS RUNNING", "‚ùå MONGODB NON TROUVE"))
| project MongoStatus, PodsTotal, PodsRunning, DerniereActivite, Namespaces

// üöÄ V√âRIFICATION RAPIDE - Activit√© g√©n√©rale du cluster (derni√®re heure)
union
    (KubeNodeInventory | where ClusterName == "K8workshopaks-restored" | where TimeGenerated > ago(1h) | summarize count() | extend Type = "Nodes"),
    (KubePodInventory | where ClusterName == "K8workshopaks-restored" | where TimeGenerated > ago(1h) | summarize count() | extend Type = "Pods"),
    (KubeEvents | where ClusterName == "K8workshopaks-restored" | where TimeGenerated > ago(1h) | summarize count() | extend Type = "Events"),
    (ContainerLogV2 | where * contains "mongodb" | where TimeGenerated > ago(1h) | summarize count() | extend Type = "MongoDB Logs")
| extend Status = iff(count_ > 0, "‚úÖ ACTIF", "‚ö†Ô∏è INACTIF")
| project Type, Status, Records = count_